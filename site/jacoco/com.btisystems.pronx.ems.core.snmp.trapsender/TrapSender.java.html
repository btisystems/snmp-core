<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TrapSender.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">snmp-core</a> &gt; <a href="index.source.html" class="el_package">com.btisystems.pronx.ems.core.snmp.trapsender</a> &gt; <span class="el_source">TrapSender.java</span></div><h1>TrapSender.java</h1><pre class="source lang-java linenums">/*
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.btisystems.pronx.ems.core.snmp.trapsender;

import com.btisystems.pronx.ems.core.snmp.OIDComparator;
import com.btisystems.pronx.ems.core.model.DeviceEntityDescription.FieldDescription;
import com.btisystems.pronx.ems.core.model.INotification;
import com.btisystems.pronx.ems.core.snmp.ISnmpNotificationOidLookup;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.snmp4j.CommunityTarget;
import org.snmp4j.PDU;
import org.snmp4j.Snmp;
import org.snmp4j.mp.SnmpConstants;
import org.snmp4j.smi.Address;
import org.snmp4j.smi.Integer32;
import org.snmp4j.smi.IpAddress;
import org.snmp4j.smi.OID;
import org.snmp4j.smi.OctetString;
import org.snmp4j.smi.TimeTicks;
import org.snmp4j.smi.UdpAddress;
import org.snmp4j.smi.UnsignedInteger32;
import org.snmp4j.smi.Variable;
import org.snmp4j.smi.VariableBinding;
import org.snmp4j.transport.DefaultUdpTransportMapping;

import java.io.IOException;
import java.lang.management.ManagementFactory;
import java.net.InetAddress;
import java.util.List;
import java.util.Map;
import java.util.TreeMap;

/**
 * The type Trap sender.
 */
<span class="fc" id="L48">public class TrapSender implements ITrapSender {</span>

<span class="fc" id="L50">    private static final Logger LOG = LoggerFactory.getLogger(TrapSender.class);</span>
    protected Snmp snmp;

    @Override
    public void send(final INotification notification, final ISnmpNotificationOidLookup lookup, final List&lt;TrapRecipient&gt; trapRecipients) {
<span class="fc" id="L55">        final PDU trap = new PDU();</span>

<span class="fc" id="L57">        trap.setType(PDU.TRAP);</span>

<span class="fc" id="L59">        final TimeTicks uptime = new TimeTicks();</span>
<span class="fc" id="L60">        uptime.fromMilliseconds(ManagementFactory.getRuntimeMXBean().getUptime());</span>

<span class="fc" id="L62">        trap.add(new VariableBinding(SnmpConstants.sysUpTime, uptime));</span>
<span class="fc" id="L63">        trap.add(new VariableBinding(SnmpConstants.snmpTrapOID, notification.get_Description().getOid()));</span>

<span class="fc" id="L65">        buildPayload(notification, lookup, trap);</span>

<span class="fc bfc" id="L67" title="All 2 branches covered.">        for (TrapRecipient trapReceiver : trapRecipients) {</span>
<span class="fc" id="L68">            sendTrap(trapReceiver, trap);</span>
<span class="fc" id="L69">        }</span>

<span class="fc" id="L71">    }</span>

    private void buildPayload(final INotification notification, final ISnmpNotificationOidLookup lookup, final PDU trap) {
<span class="fc" id="L74">        final Map&lt;String, VariableBinding&gt; variables = new TreeMap&lt;String, VariableBinding&gt;(new OIDComparator());</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">        for (FieldDescription fieldDescription : notification.get_Description().getFields()) {</span>
<span class="fc" id="L76">            final Variable variable = buildVarBind(fieldDescription, notification);</span>
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">            if (variable != null) {</span>
<span class="fc" id="L78">                final OID oid = lookup.lookupOidForField(fieldDescription);</span>
<span class="fc" id="L79">                variables.put(oid.toString(), new VariableBinding(oid, variable));</span>
            }
<span class="fc" id="L81">        }</span>
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">        if (!variables.isEmpty()) {</span>
<span class="fc" id="L83">            trap.addAll(variables.values().toArray(new VariableBinding[variables.size()]));</span>
        }
<span class="fc" id="L85">    }</span>

    private void sendTrap(final TrapRecipient trapReceiver, final PDU trap) {

        try {
            // Specify receiver
<span class="fc" id="L91">            final Address targetaddress = new UdpAddress(InetAddress.getByName(trapReceiver.getIpAddress()), trapReceiver.getPort());</span>
<span class="fc" id="L92">            final CommunityTarget target = new CommunityTarget();</span>
<span class="fc" id="L93">            target.setCommunity(new OctetString(trapReceiver.getCommunity()));</span>
<span class="fc" id="L94">            target.setVersion(SnmpConstants.version2c);</span>
<span class="fc" id="L95">            target.setAddress(targetaddress);</span>

<span class="fc" id="L97">            createSnmpSession();</span>

<span class="fc" id="L99">            LOG.trace(&quot;Sending trap:{} to {} ...&quot;, trap, trapReceiver);</span>

<span class="fc" id="L101">            snmp.send(trap, target);</span>

<span class="fc" id="L103">        } catch (IOException ex) {</span>
<span class="fc" id="L104">            LOG.error(&quot;Error sending trap:&quot; + trap + &quot; to receiver:&quot; + trapReceiver, ex);</span>
<span class="fc" id="L105">        }</span>
<span class="fc" id="L106">    }</span>

    private Variable buildVarBind(final FieldDescription fieldDescription, final INotification notification) {
<span class="fc" id="L109">        Variable result = null;</span>
<span class="pc bpc" id="L110" title="1 of 6 branches missed.">        switch (fieldDescription.getType()) {</span>
            case FIXED_X10:
            case FIXED_X100:
            case FIXED_X1000:
            case INTEGER:
<span class="fc" id="L115">                result = buildNumber(notification, fieldDescription);</span>
<span class="fc" id="L116">                break;</span>
            case STRING:
            case BITS:
            case OID:
<span class="fc" id="L120">                result = buildString(notification, fieldDescription);</span>
<span class="fc" id="L121">                break;</span>
            case DATE_AND_TIME:
<span class="fc" id="L123">                result = buildDateTime(notification, fieldDescription);</span>
<span class="fc" id="L124">                break;</span>
            case IP_ADDRESS:
<span class="fc" id="L126">                result = buildIPAddress(notification, fieldDescription);</span>
<span class="fc" id="L127">                break;</span>
            case UNSIGNED32:
<span class="fc" id="L129">                result = buildUnsigned(notification, fieldDescription);</span>
<span class="fc" id="L130">                break;</span>
            case ENTITY:
            case TABLE:
            default:
<span class="pc" id="L134">                LOG.error(&quot;Unexpected type in Notification: {}&quot;, fieldDescription);</span>
        }
<span class="fc" id="L136">        return result;</span>

    }

    protected void createSnmpSession() throws IOException {
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">        if (snmp == null) {</span>
<span class="fc" id="L142">            snmp = new Snmp(new DefaultUdpTransportMapping());</span>
        }
<span class="fc" id="L144">    }</span>

    private Variable buildNumber(final INotification notification, final FieldDescription fieldDescription) {
        Variable result;
<span class="fc" id="L148">        result = new Integer32(notification.getInt(fieldDescription.getName()));</span>
<span class="fc" id="L149">        return result;</span>
    }

    private Variable buildString(final INotification notification, final FieldDescription fieldDescription) {
<span class="fc" id="L153">        Variable result = null;</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">        if (notification.getString(fieldDescription.getName()) != null) {</span>
<span class="fc" id="L155">            result = new OctetString(notification.getString(fieldDescription.getName()));</span>
        }
<span class="fc" id="L157">        return result;</span>
    }

    private Variable buildDateTime(final INotification notification, final FieldDescription fieldDescription) {
<span class="fc" id="L161">        Variable result = null;</span>
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">        if (notification.getString(fieldDescription.getName()) != null) {</span>
<span class="fc" id="L163">            result = OctetString.fromHexString(notification.getString(fieldDescription.getName()), ':');</span>
        }
<span class="fc" id="L165">        return result;</span>
    }

    private Variable buildIPAddress(final INotification notification, final FieldDescription fieldDescription) {
<span class="fc" id="L169">        Variable result = null;</span>
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">        if (notification.getString(fieldDescription.getName()) != null) {</span>
<span class="fc" id="L171">            result = new IpAddress(notification.getString(fieldDescription.getName()));</span>
        }
<span class="fc" id="L173">        return result;</span>
    }

    private Variable buildUnsigned(final INotification notification, final FieldDescription fieldDescription) {
        Variable result;
<span class="fc" id="L178">        result = new UnsignedInteger32(notification.getInt(fieldDescription.getName()));</span>
<span class="fc" id="L179">        return result;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>